"use strict";(self["webpackChunkrock_sugar"]=self["webpackChunkrock_sugar"]||[]).push([[527],{7527:function(e,t,n){n.r(t),n.d(t,{default:function(){return T}});var r=n(3396);function i(e,t,n,i,s,o){const a=(0,r.up)("nano_webgl_scene_panel");return(0,r.wg)(),(0,r.j4)(a,{prop_des_data:s.desData,prop_ui_setter:s.uiSetter,prop_section_params:s.sectionParams,ref:"page",onInit:o.Init,onRender:o.Render,onProp_ui_setter:s.uiSetter},null,8,["prop_des_data","prop_ui_setter","prop_section_params","onInit","onRender","onProp_ui_setter"])}n(8675),n(3408),n(4590),n(7658),n(1703);var s="\nattribute vec4 a_POSITION;\nattribute vec3 a_NORMAL;\nattribute vec4 a_WEIGHTS_0;\nattribute vec4 a_JOINTS_0;\n\nuniform mat4 u_projection;\nuniform mat4 u_view;\nuniform mat4 u_world;\nuniform sampler2D u_jointTexture;\nuniform float u_numJoints;\n\nvarying vec3 v_normal;\n\n// these offsets assume the texture is 4 pixels across\n#define ROW0_U ((0.5 + 0.0) / 4.)\n#define ROW1_U ((0.5 + 1.0) / 4.)\n#define ROW2_U ((0.5 + 2.0) / 4.)\n#define ROW3_U ((0.5 + 3.0) / 4.)\n\nmat4 getBoneMatrix(float jointNdx) {\n  float v = (jointNdx + 0.5) / u_numJoints;\n  return mat4(\n    texture2D(u_jointTexture, vec2(ROW0_U, v)),\n    texture2D(u_jointTexture, vec2(ROW1_U, v)),\n    texture2D(u_jointTexture, vec2(ROW2_U, v)),\n    texture2D(u_jointTexture, vec2(ROW3_U, v)));\n}\n\nvoid main() {\n  mat4 skinMatrix = getBoneMatrix(a_JOINTS_0[0]) * a_WEIGHTS_0[0] +\n                    getBoneMatrix(a_JOINTS_0[1]) * a_WEIGHTS_0[1] +\n                    getBoneMatrix(a_JOINTS_0[2]) * a_WEIGHTS_0[2] +\n                    getBoneMatrix(a_JOINTS_0[3]) * a_WEIGHTS_0[3];\n  mat4 world = u_world * skinMatrix;\n  gl_Position = u_projection * u_view * world * a_POSITION;\n  v_normal = mat3(world) * a_NORMAL;\n\n  // for debugging .. see article\n  //gl_Position = u_projection * u_view *  a_POSITION;\n  //v_normal = a_NORMAL;\n  //v_normal = a_WEIGHTS_0.xyz * 2. - 1.;\n  //v_normal = a_JOINTS_0.xyz / (u_numJoints - 1.) * 2. - 1.;\n}\n",o="\nattribute vec4 a_POSITION;\nattribute vec3 a_NORMAL;\n\nuniform mat4 u_projection;\nuniform mat4 u_view;\nuniform mat4 u_world;\n\nvarying vec3 v_normal;\n\nvoid main() {\n  gl_Position = u_projection * u_view * u_world * a_POSITION;\n  v_normal = mat3(u_world) * a_NORMAL;\n}\n\n",a="\nprecision mediump float;\n\nvarying vec3 v_normal;\n\nuniform vec4 u_diffuse;\nuniform vec3 u_lightDirection;\n\nvoid main () {\n  vec3 normal = normalize(v_normal);\n  float light = dot(u_lightDirection, normal) * .5 + .5;\n  // gl_FragColor = vec4(u_diffuse.rgb , u_diffuse.a);\n\n  // for debugging .. see article\n  gl_FragColor = vec4(1, 0, 0, 1);\n  gl_FragColor = vec4(v_normal * .5 + .5, 1);\n}\n\n";class l{constructor(e){this.mesh=e}render(e,t,n,r){const{mesh:i}=this;gl.useProgram(meshProgramInfo.program);for(const s of i.primitives)HNWUEngine.setBuffersAndAttributes(gl,meshProgramInfo,s.bufferInfo),HNWUEngine.setUniforms(meshProgramInfo,{u_projection:t,u_view:n,u_world:e.worldMatrix}),HNWUEngine.setUniforms(meshProgramInfo,s.material.uniforms),HNWUEngine.setUniforms(meshProgramInfo,r),HNWUEngine.drawBufferInfo(gl,s.bufferInfo)}}class c{constructor(e=[0,0,0],t=[0,0,0,1],n=[1,1,1]){this.position=e,this.rotation=t,this.scale=n}getMatrix(e){return e=e||new Float32Array(16),HNWUEngine.compose(this.position,this.rotation,this.scale,e),e}}class u{constructor(e,t){this.name=t,this.source=e,this.parent=null,this.children=[],this.localMatrix=HNWUEngine.identity(),this.worldMatrix=HNWUEngine.identity(),this.drawables=[]}setParent(e){this.parent&&(this.parent._removeChild(this),this.parent=null),e&&(e._addChild(this),this.parent=e)}updateWorldMatrix(e){const t=this.source;t&&t.getMatrix(this.localMatrix),e?HNWUEngine.multiply3d(e,this.localMatrix,this.worldMatrix):HNWUEngine.copy(this.localMatrix,this.worldMatrix);const n=this.worldMatrix;for(const r of this.children)r.updateWorldMatrix(n)}traverse(e){e(this);for(const t of this.children)t.traverse(e)}_addChild(e){this.children.push(e)}_removeChild(e){const t=this.children.indexOf(e);this.children.splice(t,1)}}class f{constructor(e,t,n){this.joints=t,this.inverseBindMatrices=[],this.jointMatrices=[],this.jointData=new Float32Array(16*t.length);for(let r=0;r<t.length;++r)this.inverseBindMatrices.push(new Float32Array(n.buffer,n.byteOffset+16*Float32Array.BYTES_PER_ELEMENT*r,16)),this.jointMatrices.push(new Float32Array(this.jointData.buffer,16*Float32Array.BYTES_PER_ELEMENT*r,16));this.jointTexture=e.createTexture(),e.bindTexture(e.TEXTURE_2D,this.jointTexture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE)}update(e,t){const n=HNWUEngine.inverse(t.worldMatrix);for(let r=0;r<this.joints.length;++r){const e=this.joints[r],t=this.jointMatrices[r];HNWUEngine.multiply3d(n,e.worldMatrix,t),HNWUEngine.multiply3d(t,this.inverseBindMatrices[r],t)}e.bindTexture(e.TEXTURE_2D,this.jointTexture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,4,this.joints.length,0,e.RGBA,e.FLOAT,this.jointData)}}class h{constructor(e,t){this.mesh=e,this.skin=t}render(e,t,n,r,i,s){const{skin:o,mesh:a}=this;o.update(e,n),e.useProgram(t.program);for(const l of a.primitives)HNWUEngine.setBuffersAndAttributes(e,t,l.bufferInfo),HNWUEngine.setUniforms(t,{u_projection:r,u_view:i,u_world:n.worldMatrix,u_jointTexture:o.jointTexture,u_numJoints:o.joints.length}),l.material.uniforms&&HNWUEngine.setUniforms(t,l.material.uniforms),HNWUEngine.setUniforms(t,s),HNWUEngine.drawBufferInfo(e,l.bufferInfo)}}const d={category:"Webgl",name:"Skinning",buttonContent:"查看源码",title:"蒙皮",content:"Skinning."},m={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},g={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5124:Int32Array,5125:Uint32Array,5126:Float32Array};var _={name:"Skinning",data(){return{gl:null,desData:d,perspective:{aspect:0,fieldOfViewRadians:HNWUEngine.degToRad(60),zNear:1,zFar:2e3},transform:{translation:[0,0,0],rotation:[HNWUEngine.degToRad(180),HNWUEngine.degToRad(200),HNWUEngine.degToRad(0)],scale:[1,1,1]},camera:{target:[0,0,0],position:[10,0,0],up:[0,1,0]},sectionParams:{texture:null},page:null,uiSetter:[],gltfData:null,origMatrices:null,skinProgramInfo:null,meshProgramInfo:null}},methods:{async Init(){this.page=this.$refs.page,this.gl=this.page.getGL(),this.gltfData=await this.loadGLTF("https://webglfundamentals.org/webgl/resources/models/killer_whale/whale.CYCLES.gltf"),this.perspective.aspect=this.gl.canvas.clientWidth/this.gl.canvas.clientHeight,this.skinProgramInfo=HNWUEngine.createProgramInfo(this.gl,[s,a]),this.meshProgramInfo=HNWUEngine.createProgramInfo(this.gl,[o,a]);const e=this.gl.getExtension("OES_texture_float");e?(this.origMatrices=new Map,requestAnimationFrame(this.page.Render)):console.log("NO EXTENSION!")},Render(e){if(!this.gltfData)return;console.log(this.gltfData,"gltfdata"),this.animSkin(this.gltfData.skins[0],.5*Math.sin(.001*e));const t={u_lightDirection:HNWUEngine.normalize([0,0,1])};let n=HNWUEngine.lookAt(this.camera.position,this.camera.target,this.camera.up),r=HNWUEngine.inverse(n),i=HNWUEngine.perspective(this.perspective.fieldOfViewRadians,this.perspective.aspect,this.perspective.zNear,this.perspective.zFar);const s=e=>{for(const n of e.drawables)n.skin?n.render(this.gl,this.skinProgramInfo,e,i,r,t):n.mesh?n.render(this.gl,this.meshProgramInfo,e,i,r,t):console.log("drawable have not renderer.")};for(const o of this.gltfData.scenes)o.root.updateWorldMatrix(),o.root.traverse(s);requestAnimationFrame(this.page.Render)},animSkin(e,t){for(let n=0;n<e.joints.length;++n){const r=e.joints[n];this.origMatrices.has(r)||this.origMatrices.set(r,r.source.getMatrix());const i=this.origMatrices.get(r),s=HNWUEngine.xRotate(i,t);HNWUEngine.decompose(s,r.source.position,r.source.rotation,r.source.scale)}},accessorTypeToNumComponents(e){return m[e]||throwNoKey(e)},glTypeToTypedArray(e){return g[e]||throwNoKey(e)},getAccessorTypedArrayAndStride(e,t,n){const r=t.accessors[n],i=t.bufferViews[r.bufferView],s=this.glTypeToTypedArray(r.componentType),o=t.buffers[i.buffer];return{accessor:r,array:new s(o,i.byteOffset+(r.byteOffset||0),r.count*this.accessorTypeToNumComponents(r.type)),stride:i.byteStride||0}},getAccessorAndWebGLBuffer(e,t,n){const r=t.accessors[n],i=t.bufferViews[r.bufferView];if(!i.webglBuffer){const n=e.createBuffer(),r=i.target||e.ARRAY_BUFFER,s=t.buffers[i.buffer],o=new Uint8Array(s,i.byteOffset,i.byteLength);e.bindBuffer(r,n),e.bufferData(r,o,e.STATIC_DRAW),i.webglBuffer=n}return{accessor:r,buffer:i.webglBuffer,stride:i.stride||0}},async loadGLTF(e){const t=this.gl,n=await this.loadJSON(e),r=new URL(e,location.href);n.buffers=await Promise.all(n.buffers.map((e=>{const t=new URL(e.uri,r.href);return this.loadBinary(t.href)})));const i={uniforms:{u_diffuse:[1,1,1,1]}};n.meshes.forEach((e=>{e.primitives.forEach((e=>{const r={};let s;for(const[i,a]of Object.entries(e.attributes)){const{accessor:e,buffer:o,stride:l}=this.getAccessorAndWebGLBuffer(t,n,a);s=e.count,r[`a_${i}`]={buffer:o,type:e.componentType,numComponents:this.accessorTypeToNumComponents(e.type),stride:l,offset:0|e.byteOffset}}const o={attribs:r,numElements:s};if(void 0!==e.indices){const{accessor:r,buffer:i}=this.getAccessorAndWebGLBuffer(t,n,e.indices);o.numElements=r.count,o.indices=i,o.elementType=r.componentType}e.bufferInfo=o,e.material=n.materials&&n.materials[e.material]||i}))}));const s=[],o=n.nodes;n.nodes=n.nodes.map((e=>{const{name:t,skin:r,mesh:i,translation:o,rotation:a,scale:f}=e,h=new c(o,a,f),d=new u(h,t),m=n.meshes[i];return void 0!==r?s.push({node:d,mesh:m,skinNdx:r}):m&&d.drawables.push(new l(m)),d})),n.skins=n.skins.map((e=>{const r=e.joints.map((e=>n.nodes[e])),{array:i}=this.getAccessorTypedArrayAndStride(t,n,e.inverseBindMatrices);return new f(t,r,i)}));for(const{node:a,mesh:l,skinNdx:c}of s)a.drawables.push(new h(l,n.skins[c]));n.nodes.forEach(((e,t)=>{const r=o[t].children;r&&this.addChildren(n.nodes,e,r)}));for(const a of n.scenes)a.root=new u(new c,a.name),this.addChildren(n.nodes,a.root,a.nodes);return n},addChildren(e,t,n){n.forEach((n=>{const r=e[n];r.setParent(t)}))},async loadFile(e,t){const n=await fetch(e);if(!n.ok)throw new Error(`could not load: ${e}`);return await n[t]()},async loadBinary(e){return this.loadFile(e,"arrayBuffer")},async loadJSON(e){return this.loadFile(e,"json")}}},p=n(89);const E=(0,p.Z)(_,[["render",i]]);var T=E}}]);
//# sourceMappingURL=527.ee90eb37.js.map